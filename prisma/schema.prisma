// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PaymentStatus {
  PROCESSING
  COMPLETED
}

model Student {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Personal Details
  fullName             String
  dateOfBirth          DateTime
  countryOfCitizenship String
  referralCode         String?

  // Contact Information
  primaryPhone          String
  secondaryPhone        String?
  whatsappNotifications Boolean @default(false)
  email                 String  // Removed @unique constraint to allow multiple payments from same email
  residentialAddress    String
  city                  String
  state                 String
  zipCode               String
  country               String

  // Education
  highestQualification String
  specialization       String?

  // Professional
  currentProfession   String?
  currentOrganization String?
  linkedinProfile     String?

  // Identity Document
  idType        String
  idNumber      String
  idDocument    Bytes?  // Store ID document PDF as binary
  photo         Bytes?  // Store passport-size photo as binary
  idDocumentUrl String?
  photoUrl      String?

  // Program Selection
  selectedProgram String
  programDuration Int
  programPrice    Float
  selectedAddon   String?
  addonPrice      Float?
  totalAmount     Float

  // Payment Details
  paymentId         String?
  paymentStatus     PaymentStatus @default(PROCESSING) // Updated to use enum with PROCESSING default
  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?

  exchangeRateUsed  Float? // Store the USD to INR rate used at payment time
  totalAmountINR    Float? // Store the final INR amount calculated at payment time

  invoiceLink       String? @unique // UUID for public invoice access

  // Confirmation
  agreedToTerms        Boolean @default(false)
  certifiedInformation Boolean @default(false)

  invoices Invoice[]

  @@map("students")
}

model Invoice {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoiceNumber String  @unique
  studentId     String
  student       Student @relation(fields: [studentId], references: [id])

  invoiceLink   String  @unique // UUID for public invoice access

  programName     String
  programPrice    Float
  programDuration Int   // Added duration for proper calculation
  addonName       String?
  addonPrice      Float?
  subtotal        Float // Program price * duration + addon price
  gstRate         Float   @default(18) // Added GST rate
  gstAmount       Float // Added GST amount
  total           Float // Subtotal + GST

  exchangeRateUsed Float // Store the USD to INR rate used at invoice creation time
  
  programPriceINR Float // Program price in INR at time of payment
  addonPriceINR   Float? // Addon price in INR at time of payment
  subtotalINR     Float // Subtotal in INR
  gstAmountINR    Float // GST amount in INR
  totalINR        Float // Total amount in INR

  paymentStatus String
  paymentMethod String
  paymentDate   DateTime?

  @@map("invoices")
}
